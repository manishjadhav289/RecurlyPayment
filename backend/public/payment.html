<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secure Payment - Recurly</title>
  <script src="https://js.recurly.com/v4/recurly.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .payment-container {
      background: #fff;
      border-radius: 20px;
      padding: 32px;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .header {
      text-align: center;
      margin-bottom: 24px;
    }

    .header h1 {
      font-size: 24px;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .header .amount {
      font-size: 36px;
      font-weight: bold;
      color: #6366f1;
    }

    .header .plan-name {
      font-size: 14px;
      color: #64748b;
      margin-top: 4px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 16px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .form-row {
      display: flex;
      gap: 12px;
    }

    .form-row .form-group {
      flex: 1;
    }

    /* Recurly Elements Styling */
    .recurly-element {
      height: 50px;
      padding: 14px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      background: #fff;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .recurly-element-focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .recurly-element-invalid {
      border-color: #ef4444;
    }

    .pay-button {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 8px;
    }

    .pay-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
    }

    .pay-button:disabled {
      background: #94a3b8;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .pay-button.loading {
      position: relative;
      color: transparent;
    }

    .pay-button.loading::after {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      top: 50%;
      left: 50%;
      margin-left: -12px;
      margin-top: -12px;
      border: 3px solid #fff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      display: none;
    }

    .secure-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
      color: #64748b;
      font-size: 12px;
    }

    .secure-badge svg {
      width: 16px;
      height: 16px;
    }

    .cancel-link {
      display: block;
      text-align: center;
      margin-top: 16px;
      color: #64748b;
      text-decoration: none;
      font-size: 14px;
    }

    .cancel-link:hover {
      color: #ef4444;
    }
  </style>
</head>
<body>
  <div class="payment-container">
    <div class="header">
      <h1>ðŸ’³ Secure Payment</h1>
      <div class="amount" id="displayAmount">â‚¹0</div>
      <div class="plan-name" id="displayPlan">Loading...</div>
    </div>

    <div class="error-message" id="errorMessage"></div>

    <form id="paymentForm">
      <div class="form-row">
        <div class="form-group">
          <label>First Name</label>
          <input type="text" id="firstName" placeholder="John" required>
        </div>
        <div class="form-group">
          <label>Last Name</label>
          <input type="text" id="lastName" placeholder="Doe" required>
        </div>
      </div>

      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" placeholder="john@example.com" required>
      </div>

      <div class="form-group">
        <label>Card Number</label>
        <div id="recurly-card-number" class="recurly-element"></div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Expiry Date</label>
          <div id="recurly-card-month" class="recurly-element"></div>
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <div id="recurly-card-year" class="recurly-element"></div>
        </div>
        <div class="form-group">
          <label>CVV</label>
          <div id="recurly-card-cvv" class="recurly-element"></div>
        </div>
      </div>

      <button type="submit" class="pay-button" id="payButton">
        Pay Now
      </button>
    </form>

    <div class="secure-badge">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
      </svg>
      Secured by Recurly
    </div>

    <a href="#" class="cancel-link" id="cancelLink">Cancel Payment</a>
  </div>

  <script>
    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const amount = urlParams.get('amount') || 0;
    const planCode = urlParams.get('planCode') || '';
    const planName = urlParams.get('planName') || 'Subscription';

    // Display plan info
    document.getElementById('displayAmount').textContent = `â‚¹${amount}`;
    document.getElementById('displayPlan').textContent = `${planName} Plan - Monthly`;

    // Initialize Recurly
    // TODO: Replace with your public key
    recurly.configure({
      publicKey: 'ewr1-a5dZLklS5YZe0BinMu4ral'
    });

    // Create Recurly Elements
    const elements = recurly.Elements();

    const cardNumber = elements.CardNumberElement({
      style: {
        fontSize: '16px',
        placeholder: { content: '4111 1111 1111 1111' }
      }
    });
    cardNumber.attach('#recurly-card-number');

    const cardMonth = elements.CardMonthElement({
      style: {
        fontSize: '16px',
        placeholder: { content: 'MM' }
      }
    });
    cardMonth.attach('#recurly-card-month');

    const cardYear = elements.CardYearElement({
      style: {
        fontSize: '16px',
        placeholder: { content: 'YY' }
      }
    });
    cardYear.attach('#recurly-card-year');

    const cardCvv = elements.CardCvvElement({
      style: {
        fontSize: '16px',
        placeholder: { content: '123' }
      }
    });
    cardCvv.attach('#recurly-card-cvv');

    // Add focus/blur styling
    [cardNumber, cardMonth, cardYear, cardCvv].forEach(element => {
      element.on('focus', function() {
        this.container.classList.add('recurly-element-focus');
      });
      element.on('blur', function() {
        this.container.classList.remove('recurly-element-focus');
      });
    });

    // Form submission
    const form = document.getElementById('paymentForm');
    const payButton = document.getElementById('payButton');
    const errorMessage = document.getElementById('errorMessage');

    form.addEventListener('submit', async function(event) {
      event.preventDefault();

      payButton.disabled = true;
      payButton.classList.add('loading');
      errorMessage.style.display = 'none';

      const firstName = document.getElementById('firstName').value;
      const lastName = document.getElementById('lastName').value;
      const email = document.getElementById('email').value;

      try {
        // Get token from Recurly
        const token = await new Promise((resolve, reject) => {
          recurly.token(elements, {
            first_name: firstName,
            last_name: lastName
          }, function(err, token) {
            if (err) {
              reject(err);
            } else {
              resolve(token);
            }
          });
        });

        console.log('Token received:', token.id);

        // Send to backend
        const response = await fetch('/api/subscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            token: token.id,
            planCode: planCode,
            email: email,
            firstName: firstName,
            lastName: lastName,
          }),
        });

        const result = await response.json();

        if (result.success) {
          // Notify React Native app of success
          if (window.ReactNativeWebView) {
            window.ReactNativeWebView.postMessage(JSON.stringify({
              type: 'PAYMENT_SUCCESS',
              subscriptionId: result.subscriptionId,
            }));
          } else {
            alert('Payment successful! Subscription ID: ' + result.subscriptionId);
          }
        } else {
          throw new Error(result.error || 'Payment failed');
        }
      } catch (error) {
        console.error('Payment error:', error);
        errorMessage.textContent = error.message || 'An error occurred. Please try again.';
        errorMessage.style.display = 'block';

        if (window.ReactNativeWebView) {
          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'PAYMENT_ERROR',
            message: error.message,
          }));
        }
      } finally {
        payButton.disabled = false;
        payButton.classList.remove('loading');
      }
    });

    // Cancel link
    document.getElementById('cancelLink').addEventListener('click', function(e) {
      e.preventDefault();
      if (window.ReactNativeWebView) {
        window.ReactNativeWebView.postMessage(JSON.stringify({
          type: 'PAYMENT_CANCELLED',
        }));
      } else {
        window.history.back();
      }
    });
  </script>
</body>
</html>
